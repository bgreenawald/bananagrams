<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Bananagrams</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">


    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='styles/css/game.css') }}" />
</head>

<body>
    <div class="home-container" id="css3-background-texture">
        <div class="home-content"></div>
        <div>
            <p>Your game ID is {{id}}. Share your current URL with friends and they can access the game too!</p>
        </div>
        <div id="error"></div>
        <div id="join_game">
            <p>First things first, enter your username to join the game.</p>
            <input id="player_id" type="text">
            <button id="player_id_submit" class="btn btn-primary" type="submit" onclick="player_join()">Join the Game</button>
        </div>
        <div id="message"></div>
        <div id="game_info"></div>
        <div id="options" style="display: none;">
            <button class="btn btn-primary" id="start_game_button" type="submit" onclick="start_game()">Deal the Tiles</button>
            <button class="btn btn-primary" id="split_button" type="submit" onclick="split()">Split</button>
            <button class="btn btn-primary" id="peel_button" type="submit" onclick="peel()">Peel</button>
            <button class="btn btn-primary" id="swap_button" type="submit" onclick="swap()">Swap</button>
            <button class="btn btn-primary" id="bananagrams_button" type="submit" onclick="bananagrams()">Bananagrams</button>
            <button class="btn btn-primary" id="continue_game_button" type="submit" onclick="continue_game()">Continue Game</button>
        </div>
        <div id="reset">
            <button class="btn btn-primary" id="reset_button" type="submit" onclick="reset()">Reset Game</button>
        </div>
    </div>
</body>

</html>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
    integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
</script>

<script type="text/javascript" charset="utf-8">
    // Global variables needed
    var socket = io();
    var href_parts = window.location.href.split("/");
    var game_name = href_parts[href_parts.length - 1];
    var player_id = null;
    var tiles = [];

    // Warn user before leaving
    window.onbeforeunload = function () {
        return 'Are you sure you want to leave, this will clear your board?';
    };

    // --------------------------------------
    // Actions taken on connect

    // Join the necessary room
    socket.on("connect", function () {
        socket.emit("join", {
            "name": game_name
        });
    });

    // --------------------------------------
    // Render board action
    socket.on("render_board", function (resp) {
        if (!resp.hasOwnProperty("status_code")) {
            showError("Did not recieve a response from the server.")
        } else {
            if (resp["status_code"] == 200) {
                game_state = JSON.parse(resp.payload)
                render_board(game_state)
            } else {
                if(!resp.hasOwnProperty("message")) {
                    showError("An error occurred, but no message was given.")
                } else {
                    showError(`An error occurred: ${resp["message"]}`)
                }
            }
        }
    });

    function render_board(resp) {
        console.log(resp);
        tiles = resp["players"][player_id];

        // Hide the join game option
        $("#join_game").hide();

        // Render the board based on the various game states

        // Waiting to give out tiles
        if(resp["state"] == "IDLE") {
            hideButtons();
            $("#message").innerHTML = "<p>Waiting for other players to join. When everyone is in, click 'Deal the Tiles'</p>"
            $("#options").show();
            $("#start_game_button").show();
        }// Tiles dealt, waiting to start
        else if(resp["state"] == "HIDDEN"){
            hideButtons();
            $("#message").innerHTML = "<p>Get ready! Click 'Split' when everyone is good to go.</p>"
            $("#options").show();
            $("#split_button").show();
        } // The main gamplay state
        else if(resp["state"] == "ACTIVE") {
            hideButtons();
            $("#message").innerHTML = "<p>Game on! Build a valid scrabble board with your words.</p>"
            $("#options").show();
            $("#peel_button").show();
            $("#swap_button").show();
        } // Can no longer swap
        else if(resp["state"] == "ENDGAME") {
            hideButtons();
            $("#message").innerHTML = "<p>Almost done! Be the first to complete your board.</p>"
            $("#options").show();
            $("#bananagrams_button").show();
            $("#swap_button").show();
        } // Game over
        else if(resp["state"] == "OVER") {
            hideButtons();
            $("#message").innerHTML = "<p>Game over? Check the winning board. If it's a false alarm, click 'Continue Game,' otherwise, click 'Reset Game' to play again.</p>"
            $("#options").show();
            $("#continue_game_button").show();
        } // Unknown state
        else {
            showError(`An error occurred: Unknown client state.`)
        }

    }

    // --------------------------------------
    //Client functions

    // Manually load the current board
    function load_board() {
        socket.emit("load_board", {
            "name": game_name
        })
    }

    // Join the game
    function player_join() {
        load_board();
        player_id = document.getElementById("player_id").value;
        socket.emit("player_join", {
            "name": game_name,
            "player_id": player_id
        })
    }

    // Start the game
    function start_game() {
        socket.emit("start_game", {
            "name": game_name,
        })
    }

    // Perform the split action
    function split() {
        socket.emit("split", {
            "name": game_name,
        })
    }

    // Perform the peel action
    function peel() {
        socket.emit("peel", {
            "name": game_name,
        })
    }

    // Perform a swap
    function swap() {
        var letter = tiles.pop();
        socket.emit("swap", {
            "name": game_name,
            "letter": letter,
            "player_id": player_id
        })
    }

    // Bananagrams
    function bananagrams() {
        socket.emit("bananagrams", {
            "name": game_name,
        })
    }

    // Continue the game
    function continue_game() {
        socket.emit("continue_game", {
            "name": game_name,
        })
    }

    // Reset the game
    function reset() {
        socket.emit("reset", {
            "name": game_name
        });
    }

    // --------------------------------------
    // Non-socket functions
    function showError(msg) {
        $("#error").html(msg);
    }

    function hideButtons() {
        $("#start_game_button").hide();
        $("#split_button").hide();
        $("#peel_button").hide();
        $("#swap_button").hide();
        $("#bananagrams_button").hide();
        $("#continue_game_button").hide();
    }

    // --------------------------------------
    // Keybindings

    // Player ID enter
    var input = document.getElementById("player_id");

    // Execute a function when the user releases a key on the keyboard
    input.addEventListener("keyup", function(event) {
        // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            $("#player_id_submit").click();
        }
    });

    // Peel
    document.addEventListener("keyup", function(event) {
        if (event.keyCode === 80) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            $("#peel_button").click();
        }
    });

    // Swap
    document.addEventListener("keyup", function(event) {
        if (event.keyCode === 83) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            $("#swap_button").click();
        }
    });

    // Document
    document.addEventListener("keyup", function(event) {
        if (event.keyCode === 66) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            $("#bananagrams_button").click();
        }
    });


</script>